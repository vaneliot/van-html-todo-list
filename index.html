<!DOCTYPE html>
<html lang="en">
    <head>
        <title>To Do List</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- <link href="css/style.css" rel="stylesheet"> -->
        <style>
            body {
                font-family: Calibri, Tahoma, Roboto, sans-serif;
                background-color: #243447;
                color: #F9E9E9;
            }
            .container {
                margin: auto;
                display: flex;
                flex-wrap: wrap;
                flex-direction: column;
                align-content: center;
                
            }
            
            .container > * {
                text-align: center;
                width: 60%;
                
            }

            input[type="text"] {
                margin: auto;
                border-radius: 10px;
                margin-bottom: 0.3em;
                padding: 0.3em;
            }
            #add-todo {
                background-color: #7186a0;
                font-weight: bold;
                margin: auto;
                color: cyan;
                border-radius: 2px;
                margin-top: .5em;
                padding: 0.3em;
            }

            @keyframes fade-in {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            @keyframes fade-out {
                from { opacity: 1; }
                to { opacity: 0; }
            }

            li {
                list-style-type: none;
                animation: fade-in .25s forwards;
            }

            .flex-container {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap-reverse;
                /* flex-flow: row wrap */
                position: relative;
                left: -1.2em;
            }

            .flex-item {
                background-color: #7186a0;
                border: 1px solid black;
                text-align: center;
                width: 100%;
                margin: 0.1em;
                padding-bottom: 0.7em;
            }

            .delete-btn {
                background-color: crimson;
                color: #E9E9E9;
                margin: 0.2em 1em 0.2em;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>My To-Do List</h1>
            <input id="todo-title" type="text" name="todo-title" placeholder="title" required>
            <input id="todo-desc" type="text" name="todo-desc" placeholder="description">
            <button id="add-todo">+Add</button>
            <br/ >
            <ul id="todo-list" class="flex-container">
                
            </ul>
        </div>
        <script>
            var db = window.localStorage;
            // let todos = [
            //     {
            //         id: 1,
            //         title: 'do homework',
            //         desc: 'yea',
            //         done: false
            //     },
            //     {
            //         id: 2,
            //         title: 'foo',
            //         desc: 'bar',
            //         done: true
            //     }
            // ];
            // db.setItem("todos", JSON.stringify(todos));
            
            let todos = JSON.parse(db.getItem('todos')) != null ? JSON.parse(db.getItem('todos')) : []; 
            
            var todoTitle = document.querySelector('#todo-title');
            var todoDesc = document.querySelector('#todo-desc');
            var addTodoBtn = document.querySelector('#add-todo');

            var todoList = document.querySelector('#todo-list');

            console.log('JSON.parse(db)');
            console.log(JSON.parse(db.getItem('todos')));

            class Todo {
                constructor(title, desc) {
                    this.id = new Date().getTime();
                    this.title = title;
                    this.desc = desc;
                    this.done = false;
                    this.dateCreated = new Date().toTimeString();
                }
            }

            var addTodo = () => {
                console.log('foo');
                if(todoTitle.value) {
                    let newTodo = new Todo(todoTitle.value, todoDesc.value);
                    // console.log(newTodo);
                    todos.push(newTodo);
                    db.setItem("todos", JSON.stringify(todos));
                    // loadToList(todos);   // earlier impl
                    todoList.appendChild(createTodoNode(newTodo));
                    todoTitle.value = todoDesc.value = '';
                } else {
                    alert("Todo title can't be empty :)");
                }
            }

            addTodoBtn.addEventListener('click', addTodo)

            // load todos from db to todos array
            var loadToList = (tempDb) => {
                todoList.innerHTML = '';
                for(let i=0; i<tempDb.length; i++) {
                    let li = createTodoNode(tempDb[i]);
                    todoList.appendChild(li);
                }
            }

            var createTodoNode = (todo) => {
                let li = document.createElement('li');
                let div = document.createElement('div');

                li.setAttribute('class', 'flex-item');

                let titleText = document.createTextNode(todo.title);
                let descText = document.createTextNode(todo.desc);
                let dateText = document.createTextNode(todo.dateCreated);

                let heading = document.createElement('h3');
                let p = document.createElement('p');
                let dateSpan = document.createElement('span');

                let checkBox = document.createElement('input');
                checkBox.setAttribute('type', 'checkbox');

                let deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'delete';
                deleteBtn.classList.add('delete-btn');
                deleteBtn.setAttribute('onclick', 'deleteTodo(' + todo.id + ')');

                checkBox.setAttribute('id', 'todo-'+todo.id);
                checkBox.checked = todo.done;
                
                checkBox.setAttribute('onchange', 'toggleDone(' + todo.id + ')');

                heading.appendChild(titleText);
                p.appendChild(descText);
                dateSpan.appendChild(dateText);

                div.appendChild(heading);
                div.appendChild(p);
                div.appendChild(dateSpan);
                div.appendChild(document.createElement('hr'));
                div.appendChild(checkBox);
                

                let markDoneText = document.createTextNode('mark as done');
                div.appendChild(markDoneText);
                div.appendChild(deleteBtn);

                console.log(todo.id);
                li.appendChild(div);
                li.setAttribute('id', 'todo-'+todo.id);
                return li;         
            }

            var toggleDone = (id) => {
                console.log('updated');
                let tempTodos = JSON.parse(db.getItem('todos'));
                tempTodos.forEach((element, index) => {
                    if (element.id === id) {
                        tempTodos[index].done = !tempTodos[index].done;
                    }
                });
                db.setItem('todos', JSON.stringify(tempTodos));
                console.log(JSON.parse(db.getItem('todos')));
            }

            var deleteTodo = (id) => {
                if(confirm('Are you sure you want to delete?')) {
                    // remove from localStorage
                    db.setItem('todos', JSON.stringify(JSON.parse(db.getItem('todos')).filter((todo) => {
                        return todo.id !== id;
                    })));

                    // update UI
                    let li = document.querySelector('#todo-' + id);
                    li.parentNode.removeChild(li);
                    console.log('deleted item with id ' + id);
                }  
            }

            // upon page load
            let tempDb = JSON.parse(db.getItem('todos'));
            if(tempDb != null) {
                loadToList(tempDb);
            }

            


            // Execute a function when the user releases a key on the keyboard
            // todoTitle.addEventListener("keyup", function (e) {
            //     // Number 13 is the "Enter" key on the keyboard
            //     if (e.keyCode === 13) {
            //         // Cancel the default action, if needed
            //         e.preventDefault();
            //         // Trigger the button element with a click
            //         todoTitle.click();
            //     }
            // }); 
        </script>
    </body>
</html>